---
title: "Teclo Feature Engineering"
author: "Rami"
date: "May 2, 2016"
output: html_document
---

# Setup

```{r}
options( java.parameters = "-Xmx12g" )
library(RWeka)
library(dplyr)
library(knitr)
library(reshape2)
library(caret)
library(FactoMineR)
library(corrplot)
library(impute)
```

```{r}
# normalize <- function(x, lower = min(x, na.rm = TRUE), upper = max(x, na.rm = TRUE)) {
#   return((x - lower)/(upper - lower))
# }
# centerScale <- function(x, mu = mean(x, na.rm = TRUE), sg = sd(x, na.rm = TRUE)) {
#   return((x - mu)/sg)
# }
# powerCenterScale <- function(x, mu = mean(sqrt(x), na.rm = TRUE), sg = sd(sqrt(x), na.rm = TRUE)) {
#   return(centerScale(sqrt(x), mu, sg))
# }
# logCenterScale <- function(x, mu = mean(log(x), na.rm = TRUE), sg = sd(log(x), na.rm = TRUE)) {
#   return(centerScale(log(x), mu, sg))
# }
```

# Contract References
```{r}
contracts <- read.csv("contract_ref.csv")
```

## Exploration

```{r}
# glimpse(contracts)
# contracts %>% summary()
```

```{r}
# hist(contracts$AGE)
# hist(as.integer(contracts$GENDER))
# hist(as.integer(contracts$RATE_PLAN))
# hist(as.integer(contracts$VALUE_SEGMENT))
# handset_count <- length(levels(contracts$HANDSET_NAME))
# hist(as.integer(contracts$HANDSET_NAME), breaks = handset_count)
```

## Outliers

```{r}
# contracts %>% filter(AGE > 80, AGE < 99) %>% nrow
# contracts %>% filter(AGE == 99) %>% nrow
# contracts %>% filter(AGE < 0) %>% nrow
```

```{r}
contracts$AGE[contracts$AGE == 99] <- NA
contracts$AGE[contracts$AGE <= 0] <- NA
```

## Transformation

```{r}
levels(contracts$GENDER) <- c("F", "F", "F", "M", "M", "M",  NA, NA)
levels(contracts$VALUE_SEGMENT) <- c("Core", "High", "Med-High", "Med-Low", NA, "Platinum", "Premium")
# contracts$AGE <- powerCenterScale(contracts$AGE)
contracts$HANDSET_NAME[contracts$HANDSET_NAME == ""] <- NA

contracts$RATE_PLAN[contracts$RATE_PLAN == "Open 399"] <- "RED Him"
contracts$RATE_PLAN[contracts$RATE_PLAN == "2012 Bouquet 35 Ctrl Flat"] <- "2012 Bouquet Ctrl 25"
contracts$RATE_PLAN[contracts$RATE_PLAN == "New Bouquet ESDB 25"] <- "Enterprise Shared Data Bundle"
contracts$RATE_PLAN[contracts$RATE_PLAN == "New Vodafone Business"] <- "Vodafone Business"
```

# Monthly Aggregates: train/test

```{r}
monthly <- read.csv("train.csv")
testing <- read.csv("test.csv")
```

## Exploration

```{r}
# glimpse(monthly)
# monthly %>% summary()
```

```{r}
# hist(monthly$X206_SESSION_COUNT, breaks = 100)
# hist(monthly$X206_USAGE, breaks = 100)
```

## Feature Engineering

```{r}
averageUsage <- function(dataset) {
  dataset <- dataset %>%
    mutate(AVG_USAGE = (X206_USAGE + X207_USAGE + X208_USAGE + X209_USAGE + X210_USAGE)/5) %>%
    mutate(X206_USAGE_DIFF = (X206_USAGE - AVG_USAGE)) %>%
    mutate(X207_USAGE_DIFF = (X207_USAGE - AVG_USAGE)) %>%
    mutate(X208_USAGE_DIFF = (X208_USAGE - AVG_USAGE)) %>%
    mutate(X209_USAGE_DIFF = (X209_USAGE - AVG_USAGE)) %>%
    mutate(X210_USAGE_DIFF = (X210_USAGE - AVG_USAGE))
}
monthly <- averageUsage(monthly)
testing <- averageUsage(testing)
rm(averageUsage)
```

```{r}
averageSess <- function(dataset) {
  dataset <- dataset %>%
    mutate(AVG_SESS = (X206_SESSION_COUNT+X207_SESSION_COUNT+X208_SESSION_COUNT+X209_SESSION_COUNT+X210_SESSION_COUNT)/5) %>%
    mutate(X206_SESS_DIFF = (X206_SESSION_COUNT - AVG_SESS)) %>%
    mutate(X207_SESS_DIFF = (X207_SESSION_COUNT - AVG_SESS)) %>%
    mutate(X208_SESS_DIFF = (X208_SESSION_COUNT - AVG_SESS)) %>%
    mutate(X209_SESS_DIFF = (X209_SESSION_COUNT - AVG_SESS)) %>%
    mutate(X210_SESS_DIFF = (X210_SESSION_COUNT - AVG_SESS))
}
monthly <- averageSess(monthly)
testing <- averageSess(testing)
rm(averageSess)
```

```{r}
overUse <- function(dataset) {
  dataset <- dataset %>%
    mutate(X206_TARGET = X206_USAGE_DIFF > 500) %>%
    mutate(X207_TARGET = X207_USAGE_DIFF > 500) %>%
    mutate(X208_TARGET = X208_USAGE_DIFF > 500) %>%
    mutate(X209_TARGET = X209_USAGE_DIFF > 500) %>%
    mutate(X210_TARGET = X210_USAGE_DIFF > 500)
}
monthly <- overUse(monthly)
testing <- overUse(testing)
rm(overUse)
```

```{r}
underUse <- function(dataset) {
  dataset <- dataset %>%
    mutate(X206_TARGET_INV = X206_USAGE_DIFF < -500) %>%
    mutate(X207_TARGET_INV = X207_USAGE_DIFF < -500) %>%
    mutate(X208_TARGET_INV = X208_USAGE_DIFF < -500) %>%
    mutate(X209_TARGET_INV = X209_USAGE_DIFF < -500) %>%
    mutate(X210_TARGET_INV = X210_USAGE_DIFF < -500)
}
monthly <- underUse(monthly)
testing <- underUse(testing)
rm(underUse)
```

```{r}
usagePerSession <- function(dataset) {
  dataset <- dataset %>%
    mutate(AVG_USAGE_SESS = AVG_USAGE/AVG_SESS) %>%
    mutate(X206_USAGE_SESS = X206_USAGE/X206_SESSION_COUNT) %>%
    mutate(X207_USAGE_SESS = X207_USAGE/X207_SESSION_COUNT) %>%
    mutate(X208_USAGE_SESS = X208_USAGE/X208_SESSION_COUNT) %>%
    mutate(X209_USAGE_SESS = X209_USAGE/X209_SESSION_COUNT) %>%
    mutate(X210_USAGE_SESS = X210_USAGE/X210_SESSION_COUNT)
}
monthly <- usagePerSession(monthly)
testing <- usagePerSession(testing)
rm(usagePerSession)
```
## Transformation

```{r}
powerCenterScaleLogAggr <- function(dataset) {
  dataset$X206_SESSION_COUNT <- logCenterScale(dataset$X206_SESSION_COUNT)
  dataset$X207_SESSION_COUNT <- logCenterScale(dataset$X207_SESSION_COUNT)
  dataset$X208_SESSION_COUNT <- logCenterScale(dataset$X208_SESSION_COUNT)
  dataset$X209_SESSION_COUNT <- logCenterScale(dataset$X209_SESSION_COUNT)
  dataset$X210_SESSION_COUNT <- logCenterScale(dataset$X210_SESSION_COUNT)
  dataset$X206_USAGE <-         powerCenterScale(dataset$X206_USAGE)
  dataset$X207_USAGE <-         powerCenterScale(dataset$X207_USAGE)
  dataset$X208_USAGE <-         powerCenterScale(dataset$X208_USAGE)
  dataset$X209_USAGE <-         powerCenterScale(dataset$X209_USAGE)
  dataset$X210_USAGE <-         powerCenterScale(dataset$X210_USAGE)
  dataset$AVG_USAGE <-          powerCenterScale(dataset$AVG_USAGE)
  dataset$X206_USAGE_DIFF <-    centerScale(dataset$X206_USAGE_DIFF)
  dataset$X207_USAGE_DIFF <-    centerScale(dataset$X207_USAGE_DIFF)
  dataset$X208_USAGE_DIFF <-    centerScale(dataset$X208_USAGE_DIFF)
  dataset$X209_USAGE_DIFF <-    centerScale(dataset$X209_USAGE_DIFF)
  dataset$X210_USAGE_DIFF <-    centerScale(dataset$X210_USAGE_DIFF)
  dataset$AVG_SESS <-           logCenterScale(dataset$AVG_SESS)
  dataset$X206_SESS_DIFF <-     centerScale(dataset$X206_SESS_DIFF)
  dataset$X207_SESS_DIFF <-     centerScale(dataset$X207_SESS_DIFF)
  dataset$X208_SESS_DIFF <-     centerScale(dataset$X208_SESS_DIFF)
  dataset$X209_SESS_DIFF <-     centerScale(dataset$X209_SESS_DIFF)
  dataset$X210_SESS_DIFF <-     centerScale(dataset$X210_SESS_DIFF)
  dataset$AVG_USAGE_SESS <-     powerCenterScale(dataset$AVG_USAGE_SESS)
  dataset$X206_USAGE_SESS <-    powerCenterScale(dataset$X206_USAGE_SESS)
  dataset$X207_USAGE_SESS <-    powerCenterScale(dataset$X207_USAGE_SESS)
  dataset$X208_USAGE_SESS <-    powerCenterScale(dataset$X208_USAGE_SESS)
  dataset$X209_USAGE_SESS <-    powerCenterScale(dataset$X209_USAGE_SESS)
  dataset$X210_USAGE_SESS <-    powerCenterScale(dataset$X210_USAGE_SESS)
  return(dataset)
}
# Automated in caret
# monthly <- powerCenterScaleLogAggr(monthly)
# testing <- powerCenterScaleLogAggr(testing)
rm(powerCenterScaleLogAggr)
```

## Outliers

```{r}
# summary(monthly)
```

### Session Count

### Usage

# Roaming

```{r}
roaming <- read.csv("roaming_monthly.csv")
```

## Exploration

```{r}
# glimpse(roaming)
# summary(roaming)
# hist(roaming$USAGE, breaks = 100)
# hist(roaming$SESSION_COUNT, breaks = 100)
```

## Transformation

```{r}
roaming_usage <- dcast(roaming, CONTRACT_KEY ~ CALL_MONTH_KEY, value.var = "USAGE")
colnames(roaming_usage) <- paste("ROAMING_USAGE", colnames(roaming_usage), sep = "_")
roaming_usage <- rename(roaming_usage, CONTRACT_KEY = ROAMING_USAGE_CONTRACT_KEY)
roaming_usage[is.na(roaming_usage)] <- 0

roaming_sessions <- dcast(roaming, CONTRACT_KEY ~ CALL_MONTH_KEY, value.var = "SESSION_COUNT")
colnames(roaming_sessions) <- paste("ROAMING_SESSIONS", colnames(roaming_sessions), sep = "_")
roaming_sessions <- rename(roaming_sessions, CONTRACT_KEY = ROAMING_SESSIONS_CONTRACT_KEY)
roaming_sessions[is.na(roaming_sessions)] <- 0

roaming <- merge(roaming_usage, roaming_sessions)
rm(roaming_usage, roaming_sessions)
```

```{r}
powerCenterScaleRoam <- function(dataset) {
  dataset$ROAMING_USAGE_206 <- powerCenterScale(dataset$ROAMING_USAGE_206)
  dataset$ROAMING_USAGE_207 <- powerCenterScale(dataset$ROAMING_USAGE_207)
  dataset$ROAMING_USAGE_208 <- powerCenterScale(dataset$ROAMING_USAGE_208)
  dataset$ROAMING_USAGE_209 <- powerCenterScale(dataset$ROAMING_USAGE_209)
  dataset$ROAMING_USAGE_210 <- powerCenterScale(dataset$ROAMING_USAGE_210)
  dataset$ROAMING_SESSIONS_206 <- powerCenterScale(dataset$ROAMING_SESSIONS_206)
  dataset$ROAMING_SESSIONS_207 <- powerCenterScale(dataset$ROAMING_SESSIONS_207)
  dataset$ROAMING_SESSIONS_208 <- powerCenterScale(dataset$ROAMING_SESSIONS_208)
  dataset$ROAMING_SESSIONS_209 <- powerCenterScale(dataset$ROAMING_SESSIONS_209)
  dataset$ROAMING_SESSIONS_210 <- powerCenterScale(dataset$ROAMING_SESSIONS_210)
  return(dataset)
}
```

```{r}
# Caret
# roaming <- powerCenterScaleRoam(roaming)
rm(powerCenterScaleRoam)
```

## Outliers

```{r}
# hist(roaming$CALL_MONTH_KEY)
# hist(roaming$USAGE)
# hist(roaming$SESSION_COUNT)
```

# Daily Aggregate

```{r}
daily <- read.csv("daily_aggregate.csv")
dates <- read.csv("calendar_ref.csv")
daily <- daily %>%
  rename(DATE_KEY = CALL_DATE_KEY) %>%
  merge(dates) %>%
  select(-c(MONTH_KEY, MONTH_NAME))
```

## Exploration

```{r}
# glimpse(daily)
# daily %>% summary()
```

## Transformation

```{r}
daily_sum <- daily %>%
  group_by(CONTRACT_KEY, DATE_KEY) %>%
  mutate(USAGE = sum(TOTAL_CONSUMPTION), SESSIONS = sum(NO_OF_SESSIONS)) %>%
  ungroup() %>%
  select(CONTRACT_KEY, DATE_KEY, USAGE, SESSIONS) %>%
  unique()

daily_usage <- dcast(daily_sum, CONTRACT_KEY ~ DATE_KEY, value.var = "USAGE")
colnames(daily_usage) <- paste("USAGE", colnames(daily_usage), sep = "_")
daily_usage <- rename(daily_usage, CONTRACT_KEY = USAGE_CONTRACT_KEY)

daily_sessions <- dcast(daily_sum, CONTRACT_KEY ~ DATE_KEY, value.var = "SESSIONS")
colnames(daily_sessions) <- paste("SESSIONS", colnames(daily_sessions), sep = "_")
daily_sessions <- rename(daily_sessions, CONTRACT_KEY = SESSIONS_CONTRACT_KEY)

daily <- merge(daily_usage, daily_sessions)
rm(daily_sum, daily_usage, daily_sessions)
```

## Outliers

```{r}
# hist(daily$TOTAL_CONSUMPTION, breaks = 100)
# hist(daily$NO_OF_SESSIONS, breaks = 100)
# hist(as.integer(daily$FULL_DATE))
# hist(as.integer(daily$ROAMING_FLAG))
```

# Combined: Monthly * Contracts * Roaming * Daily

```{r}
combine <- function(dataset) {
  dataset %>%
    merge(contracts, all.x = TRUE) %>%
    merge(roaming, all.x = TRUE) #%>%
    #%>% merge(daily, all.x = TRUE)
}
```

```{r}
train <- combine(monthly)
test <- combine(testing)
rm(combine)
```

## Transformation

```{r}
train$TARGET <- as.logical(train$TARGET)
# levels(train) <- c("N", "P")
test$HANDSET_NAME[test$HANDSET_NAME %in% setdiff(levels(test$HANDSET_NAME), levels(train$HANDSET_NAME))] <- NA
```

## Exploration

```{r}
# glimpse(train)
# summary(train)
```

```{r}
# glimpse(test)
# summary(test)
```

```{r}
handsetOverview <- function(x) {
  x %>%
    group_by(HANDSET_NAME) %>% 
    summarise(
      MU_USAGE_MU = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)),
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(handsetOverview(train), handsetOverview(test)) %>% kable(row.names = FALSE)
rm(handsetOverview)
```

```{r}
rateplanOverview <- function(x) {
  x %>%
    group_by(RATE_PLAN) %>% 
    summarise(
      MEAN_USAGE_MEAN = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)), 
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(rateplanOverview(train), rateplanOverview(test)) %>% kable(row.names = FALSE)
rm(rateplanOverview)
```

```{r}
valuesegmentOverview <- function(x) {
  x %>%
    group_by(VALUE_SEGMENT) %>% 
    summarise(
      MEAN_USAGE_MEAN = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)), 
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(valuesegmentOverview(train), valuesegmentOverview(test)) %>% kable(row.names = FALSE)
rm(valuesegmentOverview)
```

```{r}
# mean(train$TARGET)
```

All zeros benchmark = 0.5
Training data is skewed, while test data is symmetric.

## Feature Engineering

```{r}
binaryIndicators <- function(dataset) {
  modelFrame <- model.frame(~ ., dataset, na.action = na.pass)
  
  binary_indicators <- cbind(
    model.matrix(~ VALUE_SEGMENT - 1, data = modelFrame) %>% data.frame(),
    model.matrix(~ GENDER - 1, data = modelFrame) %>% data.frame(),
    model.matrix(~ RATE_PLAN - 1, data = modelFrame) %>% data.frame(),
    model.matrix(~ HANDSET_NAME - 1, data = modelFrame) %>% data.frame()
  )
  
  binary_indicators[is.na(binary_indicators)] <- 0

  dataset <- dataset %>%
    select(-c(VALUE_SEGMENT, GENDER, RATE_PLAN, HANDSET_NAME)) %>%
    cbind(binary_indicators)
}
#train <- binaryIndicators(train)
#test <- binaryIndicators(test)
```

# Pre-processing

```{r}
rm(daily, dates, monthly, roaming, testing, contracts)
```

## Feature Reduction

```{r}
# colSelect <- function (dataset) {
#   select(dataset,
#          RATE_PLAN,
#          HANDSET_NAME,
#          VALUE_SEGMENT,
#          GENDER)
# }
# 
# mca <- MCA(colSelect(train), graph = FALSE)
# 
# rm(colSelect)
```

```{r}
colSelect <- function (dataset) {
  binaryIndicators(dataset) %>%
  select(starts_with("RATE_PLAN"),
         starts_with("HANDSET_NAME"),
         starts_with("VALUE_SEGMENT"),
         starts_with("GENDER"))
}

pca <- prcomp(colSelect(train), center = FALSE, scale = FALSE, tol = 0.1)

reduceDim <- function (dataset) {
  res <- predict(pca, newdata = colSelect(dataset))[, 1:50]
  dataset %>%
    select(-starts_with("RATE_PLAN"),
           -starts_with("HANDSET_NAME"),
           -starts_with("VALUE_SEGMENT"),
           -starts_with("GENDER")) %>%
    cbind(res)
}

train <- reduceDim(train)
test <- reduceDim(test)

rm(colSelect,
   pca,
   reduceDim,
   binaryIndicators)
```

## BoxCox/Center/Scale

```{r}
preProc <- preProcess(select(train, -CONTRACT_KEY, -TARGET),
                      method = c("BoxCox", "center", "scale", "bagImpute"),
                      na.action = na.pass)
train <- predict(preProc, train)
test <- predict(preProc, test)
rm(preProc)
```

# Output

```{r}
write.csv(train, "engineered.train.csv", row.names = FALSE)
write.csv(test, "engineered.test.csv", row.names = FALSE)
```

# Visualization

```{r}
subs_train  <- train %>% select(GENDER, VALUE_SEGMENT, RATE_PLAN, HANDSET_NAME)
subs_test   <- test %>% select(GENDER, VALUE_SEGMENT, RATE_PLAN, HANDSET_NAME)
subs_data   <- rbind(subs_train, subs_test)

mca <- MCA(subs_data, graph = FALSE)
mca_vars <- data.frame(mca$var$coord)
mca_obs <- data.frame(mca$ind$coord, c(train$TARGET, rep(2, nrow(test))))
names(mca_obs) <- c("Dim.1", "Dim.2", "Dim.3", "Dim.4", "Dim.5", "TARGET")
```

```{r}
ggplot(data = mca_obs, aes(x = Dim.1, y = Dim.2)) +
  geom_hline(yintercept = 0, colour = "gray70") +
  geom_vline(xintercept = 0, colour = "gray70") +
  geom_point(size = 1, aes(colour = factor(TARGET), alpha = factor(TARGET))) +
  ggtitle("MCA plot of variables using R package FactoMineR") +
  scale_colour_discrete(name = "Target") +
  scale_alpha_manual(values = c(1, 1, 0.05))
```

```{r}
correlations <- cor(train %>% select(-c(AGE, GENDER, RATE_PLAN, VALUE_SEGMENT, HANDSET_NAME, TARGET)))
corrplot(correlations, order = "hclust")
#highCorr <- findCorrelation(correlations, cutoff = 0.75)
#filtered <- train[, -highCorr]
```