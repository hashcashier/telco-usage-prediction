---
title: "Teclo Feature Engineering"
author: "Rami"
date: "May 2, 2016"
output: html_document
---

# Setup

```{r}
options( java.parameters = "-Xmx12g" )
library(RWeka)
library(dplyr)
library(knitr)
library(reshape2)
```

```{r}
normalize <- function(x) {
  lower = min(x, na.rm = TRUE)
  upper = max(x, na.rm = TRUE)
  return((x - lower)/(upper - lower))
}
```

# Contract References
```{r}
contracts <- read.csv("contract_ref.csv")
```

## Exploration

```{r}
glimpse(contracts)
contracts %>% summary()
```

```{r}
hist(contracts$AGE)
hist(as.integer(contracts$GENDER))
hist(as.integer(contracts$RATE_PLAN))
hist(as.integer(contracts$VALUE_SEGMENT))
handset_count <- length(levels(contracts$HANDSET_NAME))
hist(as.integer(contracts$HANDSET_NAME), breaks = handset_count)
```

## Transformation

```{r}
levels(contracts$GENDER) <- c("F", "F", "F", "M", "M", "M",  NA, NA)
levels(contracts$VALUE_SEGMENT) <- c("Core", "High", "Med-High", "Med-Low", NA, "Platinum", "Premium")
```

## Outliers

```{r}
contracts %>% filter(AGE > 80, AGE < 99) %>% nrow
contracts %>% filter(AGE == 99) %>% nrow
contracts %>% filter(AGE < 0) %>% nrow
contracts$AGE[contracts$AGE == 99] <- NA
contracts$AGE[contracts$AGE < 0] <- NA
```

# Monthly Aggregates: train/test

```{r}
monthly <- read.csv("train.csv")
testing <- read.csv("test.csv")
```

## Exploration

```{r}
glimpse(monthly)
monthly %>% summary()
```

```{r}
session_count_resolution = 100
usage_resolution = 100
hist(monthly$X206_SESSION_COUNT, breaks = session_count_resolution)
hist(monthly$X207_SESSION_COUNT, breaks = session_count_resolution)
hist(monthly$X208_SESSION_COUNT, breaks = session_count_resolution)
hist(monthly$X209_SESSION_COUNT, breaks = session_count_resolution)
hist(monthly$X210_SESSION_COUNT, breaks = session_count_resolution)
hist(monthly$X206_USAGE, breaks = usage_resolution)
hist(monthly$X207_USAGE, breaks = usage_resolution)
hist(monthly$X208_USAGE, breaks = usage_resolution)
hist(monthly$X209_USAGE, breaks = usage_resolution)
hist(monthly$X210_USAGE, breaks = usage_resolution)
hist(monthly$TARGET)
```

## Outliers

```{r}
summary(monthly)
```

### Session Count

```{r}
session_count_threshold <- 6000
monthly %>% 
  filter(
    X206_SESSION_COUNT > session_count_threshold 
    | X207_SESSION_COUNT > session_count_threshold 
    | X208_SESSION_COUNT > session_count_threshold
    | X209_SESSION_COUNT > session_count_threshold
    | X210_SESSION_COUNT > session_count_threshold) %>% 
  nrow()
```

```{r}
cap_session_count <- function(dataset, cap) {
  dataset$X206_SESSION_COUNT[dataset$X206_SESSION_COUNT > cap] <- cap
  dataset$X207_SESSION_COUNT[dataset$X207_SESSION_COUNT > cap] <- cap
  dataset$X208_SESSION_COUNT[dataset$X208_SESSION_COUNT > cap] <- cap
  dataset$X209_SESSION_COUNT[dataset$X209_SESSION_COUNT > cap] <- cap
  dataset$X210_SESSION_COUNT[dataset$X210_SESSION_COUNT > cap] <- cap
}
cap_session_count(monthly, session_count_threshold)
cap_session_count(testing, session_count_threshold)
```

### Usage

```{r}
usage_threshold <- 20000
monthly %>% 
  filter(
    X206_USAGE > usage_threshold 
    | X207_USAGE > usage_threshold 
    | X208_USAGE > usage_threshold
    | X209_USAGE > usage_threshold
    | X210_USAGE > usage_threshold) %>% 
  nrow()
```

```{r}
cap_usage <- function(dataset, cap) {
  dataset$X206_USAGE[dataset$X206_USAGE > cap] <- cap
  dataset$X207_USAGE[dataset$X207_USAGE > cap] <- cap
  dataset$X208_USAGE[dataset$X208_USAGE > cap] <- cap
  dataset$X209_USAGE[dataset$X209_USAGE > cap] <- cap
  dataset$X210_USAGE[dataset$X210_USAGE > cap] <- cap
}
cap_usage(monthly, usage_threshold)
cap_usage(testing, usage_threshold)
```

# Roaming

```{r}
roaming <- read.csv("roaming_monthly.csv")
```

## Exploration

```{r}
glimpse(roaming)
summary(roaming)
```

## Outliers

```{r}
hist(roaming$CALL_MONTH_KEY)
hist(roaming$USAGE)
hist(roaming$SESSION_COUNT)
```

### Session Count

```{r}
roaming_session_threshold <- 1000
roaming %>% filter(SESSION_COUNT > roaming_session_threshold) %>% nrow
```

```{r}
roaming$SESSION_COUNT[roaming$SESSION_COUNT > roaming_session_threshold] <- roaming_session_threshold
```

## Transformation

```{r}
roaming_usage <- dcast(roaming, CONTRACT_KEY ~ CALL_MONTH_KEY, value.var = "USAGE")
colnames(roaming_usage) <- paste("ROAMING_USAGE", colnames(roaming_usage), sep = "_")
roaming_usage <- rename(roaming_usage, CONTRACT_KEY = ROAMING_USAGE_CONTRACT_KEY)
roaming_usage[is.na(roaming_usage)] <- 0

roaming_sessions <- dcast(roaming, CONTRACT_KEY ~ CALL_MONTH_KEY, value.var = "SESSION_COUNT")
colnames(roaming_sessions) <- paste("ROAMING_SESSIONS", colnames(roaming_sessions), sep = "_")
roaming_sessions <- rename(roaming_sessions, CONTRACT_KEY = ROAMING_SESSIONS_CONTRACT_KEY)
roaming_sessions[is.na(roaming_sessions)] <- 0

roaming <- merge(roaming_usage, roaming_sessions)
rm(roaming_usage, roaming_sessions)
```

# Daily Aggregate

```{r}
daily <- read.csv("daily_aggregate.csv")
dates <- read.csv("calendar_ref.csv")
daily <- daily %>%
  rename(DATE_KEY = CALL_DATE_KEY) %>%
  merge(dates) %>%
  select(-c(MONTH_KEY, MONTH_NAME))
```

## Exploration

```{r}
glimpse(daily)
daily %>% summary()
```

## Outliers

```{r}
hist(daily$TOTAL_CONSUMPTION, breaks = 100)
hist(daily$NO_OF_SESSIONS, breaks = 100)
hist(as.integer(daily$FULL_DATE))
hist(as.integer(daily$ROAMING_FLAG))
```

### Usage
```{r}
daily_usage_threshold <- 1*1024^3
daily %>% 
  filter(TOTAL_CONSUMPTION > daily_usage_threshold) %>%
  nrow()
```

```{r}
daily$TOTAL_CONSUMPTION[daily$TOTAL_CONSUMPTION > daily_usage_threshold] <- daily_usage_threshold
```

### Session Count
```{r}
daily_session_threshold <- 150
daily %>%
  filter(NO_OF_SESSIONS > daily_session_threshold) %>%
  nrow()
```

```{r}
daily$NO_OF_SESSIONS[daily$NO_OF_SESSIONS > daily_session_threshold] <- daily_session_threshold
```

## Transformation

```{r}
daily_sum <- daily %>%
  group_by(CONTRACT_KEY, DATE_KEY) %>%
  mutate(USAGE = sum(TOTAL_CONSUMPTION), SESSIONS = sum(NO_OF_SESSIONS)) %>%
  ungroup() %>%
  select(CONTRACT_KEY, DATE_KEY, USAGE, SESSIONS) %>%
  unique()

daily_usage <- dcast(daily_sum, CONTRACT_KEY ~ DATE_KEY, value.var = "USAGE")
colnames(daily_usage) <- paste("USAGE", colnames(daily_usage), sep = "_")
daily_usage <- rename(daily_usage, CONTRACT_KEY = USAGE_CONTRACT_KEY)

daily_sessions <- dcast(daily_sum, CONTRACT_KEY ~ DATE_KEY, value.var = "SESSIONS")
colnames(daily_sessions) <- paste("SESSIONS", colnames(daily_sessions), sep = "_")
daily_sessions <- rename(daily_sessions, CONTRACT_KEY = SESSIONS_CONTRACT_KEY)

daily <- merge(daily_usage, daily_sessions)
rm(daily_sum, daily_usage, daily_sessions)
```


# Combined: Monthly * Contracts * Roaming * Daily

```{r}
combine <- function(dataset) {
  dataset %>%
    merge(contracts, all.x = TRUE) %>%
    merge(roaming, all.x = TRUE) %>%
    merge(daily, all.x = TRUE)
}
```

```{r}
train <- combine(monthly)
test <- combine(testing)
```

## Exploration

```{r}
glimpse(train)
summary(train)
```

```{r}
glimpse(test)
summary(test)
```

```{r}
handsetOverview <- function(x) {
  x %>%
    group_by(HANDSET_NAME) %>% 
    summarise(
      MU_USAGE_MU = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)),
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(handsetOverview(train), handsetOverview(test)) %>% kable(row.names = FALSE)
```

```{r}
rateplanOverview <- function(x) {
  x %>%
    group_by(RATE_PLAN) %>% 
    summarise(
      MEAN_USAGE_MEAN = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)), 
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(rateplanOverview(train), rateplanOverview(test)) %>% kable(row.names = FALSE)
```

```{r}
valuesegmentOverview <- function(x) {
  x %>%
    group_by(VALUE_SEGMENT) %>% 
    summarise(
      MEAN_USAGE_MEAN = (mean(X206_USAGE) + mean(X207_USAGE) + mean(X208_USAGE) + mean(X209_USAGE) + mean(X210_USAGE))/5,
      USERS = length(unique(CONTRACT_KEY)), 
      TARGETS = ifelse(!is.null(x$TARGET), sum(TARGET), -1),
      PERC = ifelse(!is.null(x$TARGET), USERS/nrow(train), USERS/nrow(test))) %>% 
    arrange(desc(USERS)) %>%
    head(n = 20)
}
cbind(valuesegmentOverview(train), valuesegmentOverview(test)) %>% kable(row.names = FALSE)
```

```{r}
mean(train$TARGET)
```

All zeros benchmark = 0.5
Training data is skewed, while test data is symmetric.

## Feature Engineering

```{r}
averageUsage <- function(dataset) {
  dataset <- dataset %>%
    mutate(AVG_USAGE = (X206_USAGE + X207_USAGE + X208_USAGE + X209_USAGE + X210_USAGE)/5) %>%
    mutate(X206_USAGE_DIFF = X206_USAGE - AVG_USAGE) %>%
    mutate(X207_USAGE_DIFF = X207_USAGE - AVG_USAGE) %>%
    mutate(X208_USAGE_DIFF = X208_USAGE - AVG_USAGE) %>%
    mutate(X209_USAGE_DIFF = X209_USAGE - AVG_USAGE) %>%
    mutate(X210_USAGE_DIFF = X210_USAGE - AVG_USAGE)
}
```

```{r}
averageSess <- function(dataset) {
  dataset <- dataset %>%
    mutate(AVG_SESS = (X206_SESSION_COUNT+X207_SESSION_COUNT+X208_SESSION_COUNT+X209_SESSION_COUNT+X210_SESSION_COUNT)/5) %>%
    mutate(X206_SESS_DIFF = X206_SESSION_COUNT - AVG_SESS) %>%
    mutate(X207_SESS_DIFF = X207_SESSION_COUNT - AVG_SESS) %>%
    mutate(X208_SESS_DIFF = X208_SESSION_COUNT - AVG_SESS) %>%
    mutate(X209_SESS_DIFF = X209_SESSION_COUNT - AVG_SESS) %>%
    mutate(X210_SESS_DIFF = X210_SESSION_COUNT - AVG_SESS)
}
```

```{r}
overUse <- function(dataset) {
  dataset <- dataset %>%
    mutate(X206_TARGET = X206_USAGE_DIFF > 500) %>%
    mutate(X207_TARGET = X207_USAGE_DIFF > 500) %>%
    mutate(X208_TARGET = X208_USAGE_DIFF > 500) %>%
    mutate(X209_TARGET = X209_USAGE_DIFF > 500) %>%
    mutate(X210_TARGET = X210_USAGE_DIFF > 500)
}
```

```{r}
underUse <- function(dataset) {
  dataset <- dataset %>%
    mutate(X206_TARGET_INV = X206_USAGE_DIFF < -500) %>%
    mutate(X207_TARGET_INV = X207_USAGE_DIFF < -500) %>%
    mutate(X208_TARGET_INV = X208_USAGE_DIFF < -500) %>%
    mutate(X209_TARGET_INV = X209_USAGE_DIFF < -500) %>%
    mutate(X210_TARGET_INV = X210_USAGE_DIFF < -500)
}
```

```{r}
usagePerSession <- function(dataset) {
  dataset <- dataset %>%
    mutate(X206_USAGE_SESS = X206_USAGE/X206_SESSION_COUNT) %>%
    mutate(X207_USAGE_SESS = X207_USAGE/X207_SESSION_COUNT) %>%
    mutate(X208_USAGE_SESS = X208_USAGE/X208_SESSION_COUNT) %>%
    mutate(X209_USAGE_SESS = X209_USAGE/X209_SESSION_COUNT) %>%
    mutate(X210_USAGE_SESS = X210_USAGE/X210_SESSION_COUNT)
}
```

```{r}
normalizeVariables <- function(dataset) {
  dataset <- dataset %>%
    mutate(AGE = normalize(AGE)) %>%
    mutate(AVG_USAGE = normalize(AVG_USAGE)) %>%
    mutate(AVG_SESS = normalize(AVG_SESS)) %>%
    mutate(X206_SESSION_COUNT = normalize(X206_SESSION_COUNT)) %>%
    mutate(X207_SESSION_COUNT = normalize(X207_SESSION_COUNT)) %>%
    mutate(X208_SESSION_COUNT = normalize(X208_SESSION_COUNT)) %>%
    mutate(X209_SESSION_COUNT = normalize(X209_SESSION_COUNT)) %>%
    mutate(X210_SESSION_COUNT = normalize(X210_SESSION_COUNT)) %>%
    mutate(X206_USAGE = normalize(X206_USAGE)) %>%
    mutate(X207_USAGE = normalize(X207_USAGE)) %>%
    mutate(X208_USAGE = normalize(X208_USAGE)) %>%
    mutate(X209_USAGE = normalize(X209_USAGE)) %>%
    mutate(X210_USAGE = normalize(X210_USAGE)) %>%
    mutate(X206_USAGE_DIFF = normalize(X206_USAGE_DIFF)) %>%
    mutate(X207_USAGE_DIFF = normalize(X207_USAGE_DIFF)) %>%
    mutate(X208_USAGE_DIFF = normalize(X208_USAGE_DIFF)) %>%
    mutate(X209_USAGE_DIFF = normalize(X209_USAGE_DIFF)) %>%
    mutate(X210_USAGE_DIFF = normalize(X210_USAGE_DIFF)) %>%
    mutate(X206_SESS_DIFF = normalize(X206_SESS_DIFF)) %>%
    mutate(X207_SESS_DIFF = normalize(X207_SESS_DIFF)) %>%
    mutate(X208_SESS_DIFF = normalize(X208_SESS_DIFF)) %>%
    mutate(X209_SESS_DIFF = normalize(X209_SESS_DIFF)) %>%
    mutate(X210_SESS_DIFF = normalize(X210_SESS_DIFF)) %>%
    mutate(X206_USAGE_SESS = normalize(X206_USAGE_SESS)) %>%
    mutate(X207_USAGE_SESS = normalize(X207_USAGE_SESS)) %>%
    mutate(X208_USAGE_SESS = normalize(X208_USAGE_SESS)) %>%
    mutate(X209_USAGE_SESS = normalize(X209_USAGE_SESS)) %>%
    mutate(X210_USAGE_SESS = normalize(X210_USAGE_SESS))}
```

```{r}
binaryIndicators <- function(dataset) {
  modelFrame <- model.frame(~ ., dataset, na.action = na.pass)
  
  binary_indicators <- cbind(
    model.matrix(~ VALUE_SEGMENT - 1, data = modelFrame) %>% data.frame(),
    model.matrix(~ GENDER - 1, data = modelFrame) %>% data.frame(),
    model.matrix(~ RATE_PLAN - 1, data = modelFrame) %>% data.frame()
    #model.matrix(~ HANDSET_NAME - 1, data = modelFrame) %>% data.frame()
  )

  dataset <- dataset %>%
    select(-c(VALUE_SEGMENT, GENDER, RATE_PLAN, HANDSET_NAME)) %>%
    cbind(binary_indicators)
}
```

```{r}
featureEngineer <- function(data) {
  data <- averageUsage(data)
  data <- averageSess(data)
  data <- overUse(data)
  data <- underUse(data)
  data <- usagePerSession(data)
  data <- normalizeVariables(data)
  data <- binaryIndicators(data)
  return(data)
}

train <- train %>% featureEngineer()
test <- test %>% featureEngineer()
```


# Feature Extraction

```{r}
# AS <- make_Weka_filter("weka.filters.supervised.attribute.AttributeSelection")
# CFS <- function(form, data) {
#   return(AS(
#     formula(form),
#     data, control = Weka_control(
#       E = "weka.attributeSelection.CfsSubsetEval",
#       S = "weka.attributeSelection.GreedyStepwise")))
# }
```

```{r}
# CFS(TARGET ~ ., train) %>% glimpse()
```

```{r}
targetCor <- function(x) {
  x %>% 
    select(-c(CONTRACT_KEY)) %>% 
    cor() %>% 
    data.frame %>%
    select(TARGET) %>%
    arrange(desc(TARGET)) %>%
    filter(!is.na(TARGET), TARGET > 0.1)
}
targetCor(train)
```

# Output

```{r}
write.csv(train, "engineered.train.csv", row.names = FALSE)
```

```{r}
write.csv(test, "engineered.test.csv", row.names = FALSE)
```