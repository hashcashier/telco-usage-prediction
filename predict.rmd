---
title: "Telco Project"
author: "Rami"
date: "May 1, 2016"
output: html_document
---

# Setup

```{r}
options( java.parameters = "-Xmx12g" )
library(RWeka)
library(dplyr)
library(knitr)
```

```{r}
train <- function(classifier, data) {
  res <- classifier(TARGET ~ 
                    #AGE
                    #+ GENDER 
                    #+ RATE_PLAN 
                    VALUE_SEGMENT 
                    #+ HANDSET_NAME
                    
                    #+ X206_SESS_DIFF 
                    + X206_USAGE_DIFF 
                    #+ X206_USAGE
                    #+ X206_SESSION_COUNT
                    #+ X206_USAGE_SESS
                    
                    #+ X207_SESS_DIFF
                    + X207_USAGE_DIFF 
                    #+ X207_USAGE
                    #+ X207_SESSION_COUNT
                    #+ X207_USAGE_SESS
                    
                    #+ X208_SESS_DIFF 
                    + X208_USAGE_DIFF 
                    #+ X208_USAGE
                    #+ X208_SESSION_COUNT
                    #+ X208_USAGE_SESS
                    
                    #+ X209_SESS_DIFF 
                    #+ X209_USAGE_DIFF 
                    + X209_USAGE
                    #+ X209_SESSION_COUNT
                    #+ X209_USAGE_SESS
                    
                    #+ X210_SESS_DIFF 
                    + X210_USAGE_DIFF 
                    + X210_USAGE
                    + X210_SESSION_COUNT
                    + X210_USAGE_SESS
                    
                    + AVG_USAGE
                    #+ AVG_SESS
                    , data)
  return(res)
}

predsave <- function(cls, dat, name) {
  res <- dat %>%
    mutate(PREDICTED_TARGET = predict(cls, dat)) %>%
    select(CONTRACT_KEY, PREDICTED_TARGET)
  res %>% write.csv(name, row.names = FALSE)
  return(res)
}
```

```{r}
classifierStats <- function(classifier) {
  entireDataSet <- summary(classifier)
  print(entireDataSet)
  print(calculateMetrics(entireDataSet))
  return(classifier)
}

compareWithKFold <- function(classifier, K = 12) {
  kfold <- evaluate_Weka_classifier(classifier, numFolds = K)
  print(kfold)
  print(calculateMetrics(kfold))
  return(kfold)
}

calculateMetrics <- function(kfold) {
  TP <- kfold$confusionMatrix[1, 1]
  TN <- kfold$confusionMatrix[2, 2]
  FP <- kfold$confusionMatrix[2, 1]
  FN <- kfold$confusionMatrix[1, 2]
  
  accuracy  <- (TP + TN) / (TP + TN + FP + FN)
  precision <- TP / (TP + FP)
  recall    <- TP / (TP + FN)
  f1        <- 2 * precision * recall / (precision + recall)
  
  res <- list(Accuracy = accuracy, Precision = precision, Recall = recall, F1 = f1)
  return(res)
}
```

```{r}
RF <- make_Weka_classifier("weka/classifiers/trees/RandomForest")
NB <- make_Weka_classifier("weka/classifiers/bayes/NaiveBayes")
MLP <- make_Weka_classifier("weka/classifiers/functions/MultilayerPerceptron")
MLP5 <- function(form, data, options = list(model = TRUE)) {
  # Faster training with only 5 epochs
  return(MLP(formula(form), data, control = Weka_control(N = 5), options = options))
}
C45Bagging <- function(form, data, options = list(model = TRUE)) {
  return(Bagging(formula(form), data, control = Weka_control(W = "weka.classifiers.trees.J48"), options = options))
}
```

# Data

```{r}
procData <- function(data, target = TRUE) {
  res <- data %>%
    mutate(AVG_USAGE = (X206_USAGE + X207_USAGE + X208_USAGE + X209_USAGE + X210_USAGE)/5) %>%
    mutate(X206_USAGE_DIFF = X206_USAGE - AVG_USAGE) %>%
    mutate(X207_USAGE_DIFF = X207_USAGE - AVG_USAGE) %>%
    mutate(X208_USAGE_DIFF = X208_USAGE - AVG_USAGE) %>%
    mutate(X209_USAGE_DIFF = X209_USAGE - AVG_USAGE) %>%
    mutate(X210_USAGE_DIFF = X210_USAGE - AVG_USAGE) %>%
    mutate(AVG_SESS = (X206_SESSION_COUNT+X207_SESSION_COUNT+X208_SESSION_COUNT+X209_SESSION_COUNT+X210_SESSION_COUNT)/5) %>%
    mutate(X206_SESS_DIFF = X206_SESSION_COUNT - AVG_USAGE) %>%
    mutate(X207_SESS_DIFF = X207_SESSION_COUNT - AVG_USAGE) %>%
    mutate(X208_SESS_DIFF = X208_SESSION_COUNT - AVG_USAGE) %>%
    mutate(X209_SESS_DIFF = X209_SESSION_COUNT - AVG_USAGE) %>%
    mutate(X210_SESS_DIFF = X210_SESSION_COUNT - AVG_USAGE) %>%
    mutate(X206_USAGE_SESS = X206_USAGE/X206_SESSION_COUNT) %>%
    mutate(X207_USAGE_SESS = X207_USAGE/X207_SESSION_COUNT) %>%
    mutate(X208_USAGE_SESS = X208_USAGE/X208_SESSION_COUNT) %>%
    mutate(X209_USAGE_SESS = X209_USAGE/X209_SESSION_COUNT) %>%
    mutate(X210_USAGE_SESS = X210_USAGE/X210_SESSION_COUNT)
  
  if (target)
    res <- res %>% mutate(TARGET = as.factor(TARGET))
  
  levels(res$GENDER) <- c("F", "F", "F", "M", "M", "M",  NA, NA)
  levels(res$VALUE_SEGMENT) <- c("Core", "High", "Med-High", "Med-Low", NA, "Platinum", "Premium")
  return(res)
}
```

```{r}
dam <- read.csv("train.csv") %>% left_join(read.csv("contract_ref.csv")) %>% procData()
```

```{r}
test <- read.csv("test.csv") %>% left_join(read.csv("contract_ref.csv")) %>% procData(target = FALSE)
```

# Features

```{r}
AS <- make_Weka_filter("weka.filters.supervised.attribute.AttributeSelection")
CFS <- function(form, data) {
  return(AS(
    formula(form),
    data, control = Weka_control(
      E = "weka.attributeSelection.CfsSubsetEval",
      S = "weka.attributeSelection.GreedyStepwise")))
}
```

```{r}
CFS(TARGET ~ ., dam) %>% glimpse()
```

# Train
```{r}
cls.c45 <- train(J48, dam)
cls.c45.kfold <- cls.c45 %>% compareWithKFold()
```

```{r}
cls.rf <- train(RF, dam)
cls.rf.kfold <- cls.rf %>% compareWithKFold()
```

```{r}
#cls.smo <- train(SMO, dam)
#cls.smo.kfold <- cls.smo %>% compareWithKFold()
```

```{r}
cls.nb <- train(NB, dam)
cls.nb.kfold <- cls.nb %>% compareWithKFold()
```

```{r}
#MLP(TARGET ~ . - CONTRACT_KEY, dam) %>% compareWithKFold()
cls.mlp <- train(MLP5, dam)
cls.mlp.kfold <- cls.mlp %>% compareWithKFold()
```

```{r}
cls.bag <- train(C45Bagging, dam)
cls.bag.kfold <- cls.bag %>% compareWithKFold()
```

```{r}
cls.boost <- train(AdaBoostM1, dam)
cls.boost.kfold <- cls.boost %>% compareWithKFold()
```

```{r}
cls.logit <- train(LogitBoost, dam)
cls.logit.kfold <- cls.logit %>% compareWithKFold()
```

```{r}
cls.stacking <- train(Stacking, dam)
cls.stacking.kfold <- cls.stacking %>% compareWithKFold()
```

# Test

```{r}
res.boost <- predsave(cls.boost, test, "submission.boost.csv")
```

```{r}
res.rf <- predsave(cls.rf, test, "submission.forest.csv")
```

```{r}
res.bag <- predsave(cls.bag, test, "submission.bag.csv")
```

```{r}
res.nb <- predsave(cls.nb, test, "submission.bayes.csv")
```

```{r}
res.c45 <- predsave(cls.c45, test, "submission.c45.csv")
```

```{r}
res.logit <- predsave(cls.logit, test, "submission.logit.csv")
```