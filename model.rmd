---
title: "Telco Project"
author: "Rami"
date: "May 20, 2016"
output: html_document
---

# Setup

```{r}
# options( java.parameters = "-Xmx12g" )
# library(MASS)
library(dplyr)
library(knitr)
# library(reshape2)
library(caret)
library(caretEnsemble)
library(beepr)
# library(FactoMineR)
# library(corrplot)
# library(e1071)
# library(randomForest)
# Let's not thrash my SSD to death for the sake of this project..
# library(doMC)
# registerDoMC(cores = 3)
```

```{r}
train <- read.csv("engineered.train.csv")
test <- read.csv("engineered.test.csv")
train$TARGET <- factor(train$TARGET)
levels(train$TARGET) <- c("Negative", "Positive")
```

```{r}
export_res <- function (res, fname) {
  dframe <- cbind(as.integer(test$CONTRACT_KEY), as.integer(res) - 1) %>% data.frame
  names(dframe) <- c("CONTRACT_KEY", "PREDICTED_TARGET")
  dframe$CONTRACT_KEY <- as.integer(dframe$CONTRACT_KEY)
  dframe$PREDICTED_TARGET <- as.integer(dframe$PREDICTED_TARGET)
  write.csv(dframe, fname, row.names = FALSE, quote = FALSE)
}
```

# Partial Least Squares

```{r}
set.seed(1337)
alternate_train <- downSample(select(train, -CONTRACT_KEY, -TARGET), train$TARGET, yname = "TARGET")
model.pls <- train(x = select(alternate_train, -TARGET),
                   y = alternate_train$TARGET,
                   method = "pls",
                   tuneGrid = expand.grid(.ncomp = 1:20),
                   probMehod = "Bayes",
                   metric = "ROC",
                   na.action = na.pass,
                   trControl = trainControl(
                     #method = "cv",
                     number = 5,
                     classProbs = TRUE,
                     savePredictions = TRUE,
                     summaryFunction = twoClassSummary),
                   verbose = TRUE)
model.pls
confusionMatrix(model.pls)
beep("mario")
```

```{r}
pred.pls <- predict(model.pls, newdata = select(test, -CONTRACT_KEY))
summary(pred.pls)
```

# RPART

```{r}
set.seed(1337)
alternate_train <- upSample(select(train, -CONTRACT_KEY, -TARGET), train$TARGET, yname = "TARGET")
model.rpart <- train(x = select(alternate_train, -TARGET),
                     y = alternate_train$TARGET,
                     method = "rpart",
                     tuneLength = 10,
                     trControl = trainControl(
                       method = "cv",
                       number = 10,
                       classProbs = TRUE,
                       savePredictions = TRUE,
                       summaryFunction = twoClassSummary),
                     metric = "ROC")
model.rpart
confusionMatrix(model.rpart)
beep("complete")
```

```{r}
pred.rpart <- predict(model.rpart, newdata = test)
summary(pred.rpart)
```

# Random Forest

```{r}
set.seed(1337)
alternate_train <- upSample(select(train, -CONTRACT_KEY, -TARGET), train$TARGET, yname = "TARGET")
model.rf <-    train(x = select(alternate_train, -TARGET),
                     y = alternate_train$TARGET,
                     method = "rf",
                     preProcess = "pca",
                     tuneLength = 10,
                     trControl = trainControl(
                       method = "boot",
                       number = 1,
                       classProbs = TRUE,
                       savePredictions = TRUE,
                       summaryFunction = twoClassSummary),
                     metric = "ROC")
model.rf
confusionMatrix(model.rf)
beep("fanfare")
```

```{r}
pred.rf <- predict(model.rf, newdata = test)
summary(pred.rf)
```

# Neural Network

```{r}
set.seed(1337)
alternate_train <- downSample(select(train, -CONTRACT_KEY, -TARGET), train$TARGET, yname = "TARGET")
maxSize <- 2
numWts <- 2#maxSize * ncol(alternate_train) + maxSize + 1
model.nnet <- train(x = select(alternate_train, -TARGET),
                    y = alternate_train$TARGET,
                    method = "nnet",
                    metric = "ROC",
                    tuneGrid = expand.grid(.size = 1:maxSize,
                                           .decay = c(0, 0.1, 1, 2)),
                    #trace = FALSE,
                    maxit = 10,
                    MaxNWts = numWts,
                    trControl = trainControl(
                       #method = "cv",
                       number = 2,
                       classProbs = TRUE,
                       savePredictions = TRUE,
                       summaryFunction = twoClassSummary))
model.nnet
confusionMatrix(model.nnet)
beep("ready")
```

```{r}
pred.nnet <- predict(model.nnet, newdata = test)
summary(pred.nnet)
```

# Ensemble

```{r}
set.seed(1337)
alternate_train <- downSample(select(train, -CONTRACT_KEY, -TARGET), train$TARGET, yname = "TARGET")
control <- trainControl(method = "boot",
                        number = 5,
                        savePredictions = TRUE,
                        classProbs = TRUE,
                        index = createResample(alternate_train$TARGET, 5),
                        summaryFunction = twoClassSummary)

models <- list(pls = caretModelSpec(method = "pls",
                                    tuneGrid = expand.grid(.ncomp = 1:20)),
               rpart = caretModelSpec(method = "rpart",
                                      tuneLength = 10),
               rf = caretModelSpec(method="rf",
                                   tuneGrid=expand.grid(.mtry = 1:10),
                                   preProcess="pca"))

model.ensemble.list <- caretList(TARGET ~ .,
                                 data = alternate_train,
                                 trControl = control,
                                 tuneList = models,
                                 metric = "ROC")
model.ensemble.list
modelCor(resamples(model.ensemble.list))

model.ensemble <- caretEnsemble(model.ensemble.list,
                                metric = "ROC",
                                trControl = trainControl(
                                  method = "boot",
                                  number = 5,
                                  summaryFunction = twoClassSummary,
                                  classProbs = TRUE))
model.ensemble
confusionMatrix(model.ensemble$ens_model)
summary(model.ensemble)
rm(control, models)
beep("coin")
beep("treasure")
```

```{r}
pred.ensemble <- predict(model.ensemble, newdata = select(test, -CONTRACT_KEY))
summary(pred.ensemble)
```

# Stack

```{r}
model.stack <- caretStack(model.ensemble.list,
                          method = "gbm",
                          metric = "ROC",
                          tuneLength = 4,
                          trControl = trainControl(
                            method = "boot",
                            number = 5,
                            savePredictions = "final",
                            classProbs = TRUE,
                            summaryFunction = twoClassSummary))

model.stack
confusionMatrix(model.stack$ens_model)
summary(model.stack)
beep("shotgun")
beep("wilhelm")
```

```{r}
pred.stack <- predict(model.stack, newdata = select(test, -CONTRACT_KEY))
summary(pred.stack)
```

# Discriminant Analysis

```{r}
model.qda <- qda(TARGET ~ ., data = train)
```
